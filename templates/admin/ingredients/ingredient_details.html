<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ingredient Details</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body class="recipes-page">
  <div class="nav-container">
    <div class="admin-options">
      <a href="/admin/ingredients" class="admin-link">Ingredients</a>
      <a href="/admin/recipes" class="admin-link">Recipes</a>
      <a href="/admin/users" class="admin-link">Users</a>
      <a href="/admin/dishes" class="admin-link">Dishes</a>
    </div>
    <a href="/recipes/" class="my-recipes">Recipes</a>
  </div>
  <h2>Ingredient Details</h2>
  <div id="ingredientDetails">
    <p><strong>ID:</strong> <span id="ingredientId"></span></p>
    <p><strong>Name:</strong> <span id="ingredientName"></span></p>
    <p><strong>Base Unit:</strong> <span id="baseUnit"></span></p>
    <p><strong>Default Price:</strong> <span id="defaultPrice"></span></p>
    <p><strong>Active:</strong> <span id="isActive"></span></p>
    <p><strong>Submitted By:</strong> <span id="submittedBy"></span></p>
    <p><strong>Approved By:</strong> <span id="approvedBy"></span></p>
    <p><strong>Approval Status:</strong> <span id="approvalStatus"></span></p>
    <p><strong>Approval Date:</strong> <span id="approvalDate"></span></p>
    <p><strong>End Date:</strong> <span id="endDate"></span></p>
    <p><strong>Created At:</strong> <span id="createdAt"></span></p>
    <p><strong>Notes:</strong> <span id="notes"></span></p>
  </div>
  <div class="action-container">
    <div class="button-group">
        <button id="edit-ingredient-btn" class="action-btn edit-btn">Edit</button>
        <button id="delete-ingredient-btn" class="action-btn delete-btn">Delete</button>
    </div>
    <a href="/admin/ingredients" class="back-link">Back to Ingredients</a>
    </div>
  <div id="error"></div>



  
  <script>
    const token = localStorage.getItem("access_token");
    console.log("token is :",token);
    const ingredientId = window.location.pathname.split('/').pop();

    function getUserRole(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload).role;
      } catch (e) {
        return null;
      }
    }

    async function loadIngredientDetails() {
      try {
        const res = await fetch(`/ingredients/api/ingredient/${ingredientId}`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        if (!res.ok) {
          throw new Error("Failed to load ingredient details");
        }
        const data = await res.json();
        const details = data.details;
        document.getElementById("ingredientId").textContent = details.ingredient_id;
        document.getElementById("ingredientName").textContent = details.name;
        document.getElementById("baseUnit").textContent = details.base_unit;
        document.getElementById("defaultPrice").textContent = parseFloat(details.default_price).toFixed(2);
        document.getElementById("isActive").textContent = details.is_active ? 'Yes' : 'No';
        document.getElementById("submittedBy").textContent = details.submitted_by || '';
        document.getElementById("approvedBy").textContent = details.approved_by || '';
        document.getElementById("approvalStatus").textContent = details.approval_status || '';
        document.getElementById("approvalDate").textContent = details.approval_date || '';
        document.getElementById("endDate").textContent = details.end_date || '';
        document.getElementById("createdAt").textContent = details.created_at || '';
        document.getElementById("notes").textContent = details.notes || '';
      } catch (err) {
        document.getElementById("error").textContent = err.message;
      }
    }

   

    if (token) {
      console.log("token is available and not expired");  
      const role = getUserRole(token);
      if (role === 'admin') {
        document.querySelector('.admin-options').style.display = 'inline-flex';
        loadIngredientDetails();
      } else {
        console.log("token is NOT available OR expired");
        localStorage.removeItem("access_token");
        document.getElementById("error").textContent = "Admin privileges required.";
        setTimeout(() => { window.location.href = "/auth/login"; }, 2000);
      }
    } else {
      document.getElementById("error").textContent = "Please log in to view ingredient details.";
      setTimeout(() => { window.location.href = "/auth/login"; }, 2000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const editBtn = document.getElementById("edit-ingredient-btn");
      editBtn.addEventListener("click", async () => {
        try{
          window.location.href = `/admin/ingredient/edit/${ingredientId}`;          
        } catch(err) {
          document.getElementById("error").textContent = err.message;
        }
      });
    });
  </script>
</body>
</html>