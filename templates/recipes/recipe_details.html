<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Recipe Details</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body class="recipes-page">
  <a href="/recipes/" class="back-link">← All Recipes</a>
  <h1 id="recipe-name">Recipe Name</h1>
  <p id="recipe-info"></p>

  <h2>Ingredients</h2>
  <table id="ingredients-table">
    <thead>
      <tr>
        <th>Ingredient</th>
        <th>Quantity</th>
        <th>Unit</th>
        <th>Cost</th>
        <th>Base Quantity</th>
        <th>Base unit</th>
        <th>Base Price</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="steps-container"></div>

  <div id="error"></div>
  <!-- show the below buttons only if logged in user and recipe owner same-->
  <div id="recipe-actions" style="margin-top: 2rem; display: none;">
    <button id="edit-recipe-btn" class="action-btn edit-btn">Edit Recipe</button>
    <button id="delete-recipe-btn" class="action-btn delete-btn">Delete Recipe</button>
  </div>
  <div id="modal-overlay" class="modal-overlay" style="display:none;">
    <div id="alert-box" class="alert-box">
      <p id="alert-message"></p>
      <div id="alert-actions" style="display:none;">
        <button id="alert-ok">OK</button>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("access_token");
    function parseJwt(token) {
        try {
            const base64Payload = token.split('.')[1]; 
            const payload = atob(base64Payload);  // decode base64
            return JSON.parse(payload);
        } catch (e) {
            console.error("Invalid token", e);
            return null;
        }
    }
    const decoded = parseJwt(token); //console.log("decoded : ",decoded)
    const loggedInUserId = parseInt(decoded ? decoded.sub : null); //console.log("user _id: ",loggedInUserId)
    const recipeId = window.location.pathname.split("/").pop(); //console.log("Recipe ID from Flask:", recipeId);
    
    async function loadRecipeDetails() {
      try {
        const res = await fetch(`/recipes/api/recipe/${recipeId}`, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) {
          throw new Error("Failed to load recipe details");
        }

        const data = await res.json(); //console.log("data from backend: ", data);
        const recipeOwnerId = data.recipe['user_id']; //console.log(" recipe user id : ", recipe_user_id)
        const recipe = data.recipe;
        const ingredients = data.ingredients;
        const steps = data.steps;

        // check logged in user and recipe owner same or not and show buttons accordingly
        if (loggedInUserId && loggedInUserId === recipeOwnerId) {
            document.getElementById('recipe-actions').style.display = 'block';
        } else {
            document.getElementById('recipe-actions').style.display = 'none';
        }

        // Recipe Info
        document.getElementById("recipe-name").textContent = recipe.name;
        document.getElementById("recipe-info").innerHTML = `
          <strong>Portion Size:</strong> ${recipe.portion_size} |
          <strong>By:</strong> ${recipe.username} |
          <strong>Created At:</strong> ${recipe.created_at}
        `;

        // Ingredients Table
        const tbody = document.querySelector("#ingredients-table tbody");
        tbody.innerHTML = "";
        ingredients.forEach(i => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${i.name}</td>
            <td>${i.quantity}</td>
            <td>${i.unit_name}</td>
            <td>${Number(i.price).toFixed(4)}</td>
            <td>${Number(1)}</td>
            <td>${i.unit}</td>
            <td>${Number(i.cost).toFixed(2)}</td>
          `;
          tbody.appendChild(tr);
        });

        // Steps (numbered list)
        const stepsContainer = document.getElementById("steps-container");
        stepsContainer.innerHTML = "";
        if (steps.length > 0) {
          const stepsTitle = document.createElement("h2");
          stepsTitle.textContent = "Steps";
          stepsContainer.appendChild(stepsTitle);

          const ol = document.createElement("ol");
          steps.forEach(s => {
            const li = document.createElement("li");
            li.textContent = s.step_text;
            ol.appendChild(li);
          });
          stepsContainer.appendChild(ol);
        }

      } catch (err) {
        document.getElementById("error").textContent = err.message;
      }
    }

    function showAlert(message, isError = false, autoClose = true) {
      const overlay = document.getElementById("modal-overlay");
      const alertBox = document.getElementById("alert-box");
      const alertMessage = document.getElementById("alert-message");
      const alertActions = document.getElementById("alert-actions");

      alertMessage.textContent = message;
      alertBox.className = "alert-box" + (isError ? " error" : " success");
      overlay.style.display = "flex";
      alertActions.style.display = "none"; // hide OK button if autoclose

      if (autoClose) {
        setTimeout(() => {
          overlay.style.display = "none";
        }, 2000); // hide after 2s
      } else {
        alertActions.style.display = "block"; // show OK button
        document.getElementById("alert-ok").onclick = () => {
          overlay.style.display = "none";
        };
      }
    }

    function showConfirm(message) {
      return new Promise((resolve) => {
        const overlay = document.getElementById("modal-overlay");
        const alertBox = document.getElementById("alert-box");
        const alertMessage = document.getElementById("alert-message");
        const alertActions = document.getElementById("alert-actions");

        alertMessage.textContent = message;
        alertBox.className = "alert-box";
        overlay.style.display = "flex";

        // Replace actions with Yes/No buttons
        alertActions.innerHTML = `
          <button id="confirm-yes">Yes</button>
          <button id="confirm-no" style="background:#f44336;">No</button>
        `;
        alertActions.style.display = "block";

        document.getElementById("confirm-yes").onclick = () => {
          overlay.style.display = "none";
          resolve(true);
        };
        document.getElementById("confirm-no").onclick = () => {
          overlay.style.display = "none";
          resolve(false);
        };
      });
    }

    if (token) {
      loadRecipeDetails();
    } else {
      document.getElementById("error").textContent = "Please log in to view recipe details.";
      setTimeout(() => { window.location.href = "/auth/login"; }, 2000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const deleteBtn = document.getElementById("delete-recipe-btn");

      deleteBtn.addEventListener("click", async () => {
        // ✅ use custom modal confirm instead of native confirm
        const confirmed = await showConfirm("Are you sure you want to delete this recipe?");
        if (!confirmed) return;

        try {
          const response = await fetch(`/recipes/api/delete_recipe/${recipeId}`, {
            method: "DELETE",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            }
          });

          console.log("response is : ", response);
          const data = await response.json();
          console.log("data is : ", data);

          if (response.ok) {
            showAlert(data.message || "Recipe deleted successfully!");
            setTimeout(() => { window.location.href = "/recipes"; }, 2500);
          } else {
            showAlert(data.error || "Failed to delete recipe.", true);
          }
        } catch (err) {
          console.error("Error deleting recipe:", err);
          showAlert("Something went wrong.", true);
        }
      });
    });
  </script>
</body>
</html>
